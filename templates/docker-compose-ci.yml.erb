version: '2.1'
services:
<% if options[:postgres] -%>
  postgres:
    image: postgres
    env_file:
      - .env-example
    ports:
      - "5432"
<% end -%>
<% if options[:mysql] -%>
  mysql:
    image: mysql
    env_file:
      - .env-example
    ports:
      - '3306'
<% end -%>
<% if options[:elasticsearch] -%>
  elasticsearch:
    image: elasticsearch:1.7.1
    ports:
      - "9200"
      - "9300"
<% end -%>
<% if options[:solr] %>
  solr:
    image: solr:latest
    ports:
      - "8983"
    entrypoint:
      - docker-entrypoint.sh
      - solr-precreate
      - mycore
    # docker-compose exec --user=solr solr bin/solr create_core -c CORENAME
<% end -%>
<% if options[:redis] -%>
  redis:
    image: 'redis:3.2-alpine'
    command: redis-server
    ports:
      - '6379'
<% end -%>
<% if options[:mongodb] -%>
  mongodb:
    image: mongo:2.6.12
    ports:
      - "27017"
<% end -%>
<% if options[:memcached] -%>
  memcached:
    image: memcached
    ports:
      - "11211"
<% end -%>
<% if options[:fcrepo] -%>
  fcrepo:
    image: botimer/fcrepo:4.5.1
    volumes:
      - 'fcrepo:/opt/data'
    ports:
      - "8080"
<% end -%>
  web:
    image: "${REGISTRY_HOST}/${REGISTRY_URI}:${TAG:-master}"
    env_file:
      - .env-example
    labels:
      rap.host: ${SITE_URI}
      rap.le_host: ${SITE_URI}
      rap.le_test: true
      io.rancher.container.pull_image: always
    ports:
      - "80"
    depends_on:
<%= compose_depends %>
